{"ast":null,"code":"import _regeneratorRuntime from\"C:/Benkia/MERN/instagram-clone/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Benkia/MERN/instagram-clone/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"C:/Benkia/MERN/instagram-clone/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"C:/Benkia/MERN/instagram-clone/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useRef,useState}from\"react\";import{useDispatch,useSelector}from\"react-redux\";import{useHistory,useParams}from\"react-router\";import LoadingIcon from\"../../assets/images/loading.gif\";import{addMessageAction,deleteConversationAction,getMessagesAction,getMoreMessagesAction}from\"../../redux/actions/messageActions\";import{MESSAGE_TYPES}from\"../../redux/types/messageTypes\";import{NOTIFY_TYPES}from\"../../redux/types/notifyTypes\";import{imageUpload}from\"../../utils/imageUpload\";import{imageShow,videoShow}from\"../../utils/mediaShow\";import UserCard from\"../UserCard\";import\"./index.scss\";import MsgDisplay from\"./MsgDisplay\";import axios from\"axios\";import{getDataAPI}from\"../../utils/fetchData\";import{CALL_TYPES}from\"../../redux/types/callTypes\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var RightSide=function RightSide(){var _useSelector=useSelector(function(state){return state;}),auth=_useSelector.auth,message=_useSelector.message,socket=_useSelector.socket,peer=_useSelector.peer;var dispatch=useDispatch();var _useParams=useParams(),id=_useParams.id;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),user=_useState2[0],setUser=_useState2[1];var _useState3=useState(\"\"),_useState4=_slicedToArray(_useState3,2),text=_useState4[0],setText=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),media=_useState6[0],setMedia=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),loadMedia=_useState8[0],setLoadMedia=_useState8[1];var refDisplay=useRef();var pageEnd=useRef();var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),isDetail=_useState10[0],setIsDetail=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),isPhone=_useState12[0],setIsPhone=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),isAudio=_useState14[0],setIsAudio=_useState14[1];var _useState15=useState([]),_useState16=_slicedToArray(_useState15,2),data=_useState16[0],setData=_useState16[1];var _useState17=useState(9),_useState18=_slicedToArray(_useState17,2),result=_useState18[0],setResult=_useState18[1];var _useState19=useState(0),_useState20=_slicedToArray(_useState19,2),page=_useState20[0],setPage=_useState20[1];var _useState21=useState(0),_useState22=_slicedToArray(_useState21,2),isLoadMore=_useState22[0],setIsLoadMore=_useState22[1];var history=useHistory();useEffect(function(){var newData=message.data.find(function(item){return item._id===id;});if(newData){setData(newData.messages);setResult(newData.result);setPage(newData.page);}},[message.data,id]);useEffect(function(){if(id&&message.users.length>0){setIsDetail(false);setTimeout(function(){refDisplay.current.scrollIntoView({behavior:\"smooth\",block:\"end\"});},50);var newUser=message.users.find(function(user){return user._id===id;});if(newUser)setUser(newUser);}},[message.users,id]);var handleChangeMedia=function handleChangeMedia(e){var files=_toConsumableArray(e.target.files);var err=\"\";var newMedia=[];files.forEach(function(file){if(!file)return err=\"File does not exist.\";if(file.size>1024*1024*5){return err=\"This image/video larget is 5mb\";}return newMedia.push(file);});if(err)dispatch({type:NOTIFY_TYPES.NOTIFY,payload:{error:err}});setMedia([].concat(_toConsumableArray(media),newMedia));};var handleDeleteMedia=function handleDeleteMedia(index){var newArr=_toConsumableArray(media);newArr.splice(index,1);setMedia(newArr);};var handleSubmit=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var newArr,msg;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:e.preventDefault();if(!(!text.trim()&&media.length===0)){_context.next=3;break;}return _context.abrupt(\"return\");case 3:setText(\"\");setMedia([]);setLoadMedia(true);newArr=[];if(!(media.length>0)){_context.next=11;break;}_context.next=10;return imageUpload(media);case 10:newArr=_context.sent;case 11:msg={sender:auth.user._id,recipient:id,text:text,media:newArr,createdAt:new Date().toISOString()};setLoadMedia(false);_context.next=15;return dispatch(addMessageAction({msg:msg,auth:auth,socket:socket}));case 15:if(refDisplay.current){refDisplay.current.scrollIntoView({behavior:\"smooth\",block:\"end\"});}case 16:case\"end\":return _context.stop();}}},_callee);}));return function handleSubmit(_x){return _ref.apply(this,arguments);};}();var handleDeleteConversation=function handleDeleteConversation(){dispatch(deleteConversationAction({auth:auth,id:id}));return history.push(\"/message\");};useEffect(function(){var getMessagesData=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!message.data.every(function(item){return item._id!==id;})){_context2.next=5;break;}_context2.next=3;return dispatch(getMessagesAction({auth:auth,id:id}));case 3:setIsDetail(false);setTimeout(function(){refDisplay.current.scrollIntoView({behavior:\"smooth\",block:\"end\"});},50);case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function getMessagesData(){return _ref2.apply(this,arguments);};}();getMessagesData();},[id,auth,dispatch,message.data]);//Load more\nuseEffect(function(){var observer=new IntersectionObserver(function(entries){if(entries[0].isIntersecting){setIsLoadMore(function(p){return p+1;});}},{threshold:0.1});observer.observe(pageEnd.current);},[setIsLoadMore]);useEffect(function(){if(isLoadMore>1){if(result>=page*9){dispatch(getMoreMessagesAction({auth:auth,id:id,page:page+1}));setIsLoadMore(1);}}},[auth,dispatch,id,page,result,isLoadMore]);//Call\nvar caller=function caller(_ref3){var video=_ref3.video;var _id=user._id,avatar=user.avatar,username=user.username,fullname=user.fullname;var msg={sender:auth.user._id,recipient:_id,avatar:avatar,username:username,fullname:fullname,video:video};dispatch({type:CALL_TYPES.CALL,payload:msg});};var callUser=function callUser(_ref4){var video=_ref4.video;var _auth$user=auth.user,_id=_auth$user._id,avatar=_auth$user.avatar,username=_auth$user.username,fullname=_auth$user.fullname;var msg={sender:_id,recipient:user._id,avatar:avatar,username:username,fullname:fullname,video:video};if(peer.open)msg.peerId=peer._id;socket.emit(\"callUser\",msg);};var handleAudioCall=function handleAudioCall(){caller({video:false});callUser({video:false});};var handleVideoCall=function handleVideoCall(){caller({video:true});callUser({video:true});};return/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsxs(\"div\",{className:\"message-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"message-heading\",children:user.length!==0&&/*#__PURE__*/_jsx(UserCard,{user:user,msg:true,children:/*#__PURE__*/_jsxs(\"div\",{className:\"message-heading-actions\",children:[/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-phone-alt message-heading-phone\",onClick:handleAudioCall}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-video message-heading-video\",onClick:handleVideoCall}),/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-info-circle\",style:{color:isDetail?\"\":\"darkgray\"},onClick:function onClick(){return setIsDetail(!isDetail);}})]})})}),isDetail?/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsxs(\"div\",{className:\"message-details\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"message-details-member\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"message-details-owner\",children:\"Members\"}),user.length!==0&&/*#__PURE__*/_jsx(UserCard,{user:user})]}),/*#__PURE__*/_jsx(\"div\",{className:\"message-details-actions\",children:/*#__PURE__*/_jsx(\"button\",{className:\"message-details-btn\",onClick:handleDeleteConversation,children:\"Delete Chat\"})})]})}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"message-chat\",style:{height:media.length>0?\"calc(100% - 186px)\":\"calc(100% - 116px)\"},children:/*#__PURE__*/_jsxs(\"div\",{className:\"message-chat-display\",ref:refDisplay,children:[/*#__PURE__*/_jsx(\"button\",{className:\"message-chat-btn\",ref:pageEnd,children:\"LoadMore\"}),data.map(function(msg,index){return/*#__PURE__*/_jsxs(\"div\",{children:[msg.sender!==auth.user._id&&/*#__PURE__*/_jsx(\"div\",{className:\"message-chat-row other-message\",children:/*#__PURE__*/_jsx(MsgDisplay,{user:user,msg:msg})}),msg.sender===auth.user._id&&/*#__PURE__*/_jsx(\"div\",{className:\"message-chat-row you-message\",children:/*#__PURE__*/_jsx(MsgDisplay,{user:auth.user,msg:msg,data:data})})]},index);}),loadMedia&&/*#__PURE__*/_jsx(\"div\",{className:\"message-chat-row you-message\",children:/*#__PURE__*/_jsx(\"img\",{src:LoadingIcon,alt:\"Loading\"})})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"message-media\",style:{display:media.length>0?\"grid\":\"none\"},children:media.map(function(item,index){return/*#__PURE__*/_jsxs(\"div\",{className:\"message-media-list\",children:[item.type.match(/video/i)?videoShow(URL.createObjectURL(item)):imageShow(URL.createObjectURL(item)),/*#__PURE__*/_jsx(\"span\",{className:\"message-media-close\",onClick:function onClick(){return handleDeleteMedia(index);},children:\"\\xD7\"})]},index);})}),/*#__PURE__*/_jsxs(\"form\",{className:\"message-form\",onSubmit:handleSubmit,children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"message-form-input\",placeholder:\"Enter your message....\",value:text,onChange:function onChange(e){return setText(e.target.value);}}),/*#__PURE__*/_jsxs(\"div\",{className:\"message-form-upload\",children:[/*#__PURE__*/_jsx(\"i\",{className:\"fas fa-image message-form-icon\"}),/*#__PURE__*/_jsx(\"input\",{type:\"file\",name:\"file\",className:\"message-form-file\",multiple:true,accept:\"image/*,video/*\",onChange:handleChangeMedia})]}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"message-form-btn\"// disabled={text || media.length > 0 ? false : true}\n,children:\"Send\"})]})]})]})});};export default RightSide;","map":{"version":3,"sources":["C:/Benkia/MERN/instagram-clone/client/src/components/RightSide/index.js"],"names":["React","useEffect","useRef","useState","useDispatch","useSelector","useHistory","useParams","LoadingIcon","addMessageAction","deleteConversationAction","getMessagesAction","getMoreMessagesAction","MESSAGE_TYPES","NOTIFY_TYPES","imageUpload","imageShow","videoShow","UserCard","MsgDisplay","axios","getDataAPI","CALL_TYPES","RightSide","state","auth","message","socket","peer","dispatch","id","user","setUser","text","setText","media","setMedia","loadMedia","setLoadMedia","refDisplay","pageEnd","isDetail","setIsDetail","isPhone","setIsPhone","isAudio","setIsAudio","data","setData","result","setResult","page","setPage","isLoadMore","setIsLoadMore","history","newData","find","item","_id","messages","users","length","setTimeout","current","scrollIntoView","behavior","block","newUser","handleChangeMedia","e","files","target","err","newMedia","forEach","file","size","push","type","NOTIFY","payload","error","handleDeleteMedia","index","newArr","splice","handleSubmit","preventDefault","trim","msg","sender","recipient","createdAt","Date","toISOString","handleDeleteConversation","getMessagesData","every","observer","IntersectionObserver","entries","isIntersecting","p","threshold","observe","caller","video","avatar","username","fullname","CALL","callUser","open","peerId","emit","handleAudioCall","handleVideoCall","color","height","map","display","match","URL","createObjectURL","value"],"mappings":"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","sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\r\nimport { useDispatch, useSelector } from \"react-redux\";\r\nimport { useHistory, useParams } from \"react-router\";\r\nimport LoadingIcon from \"../../assets/images/loading.gif\";\r\nimport {\r\n  addMessageAction,\r\n  deleteConversationAction,\r\n  getMessagesAction,\r\n  getMoreMessagesAction,\r\n} from \"../../redux/actions/messageActions\";\r\nimport { MESSAGE_TYPES } from \"../../redux/types/messageTypes\";\r\nimport { NOTIFY_TYPES } from \"../../redux/types/notifyTypes\";\r\nimport { imageUpload } from \"../../utils/imageUpload\";\r\nimport { imageShow, videoShow } from \"../../utils/mediaShow\";\r\nimport UserCard from \"../UserCard\";\r\nimport \"./index.scss\";\r\nimport MsgDisplay from \"./MsgDisplay\";\r\nimport axios from \"axios\";\r\nimport { getDataAPI } from \"../../utils/fetchData\";\r\nimport { CALL_TYPES } from \"../../redux/types/callTypes\";\r\nconst RightSide = () => {\r\n  const { auth, message, socket, peer } = useSelector((state) => state);\r\n  const dispatch = useDispatch();\r\n  const { id } = useParams();\r\n  const [user, setUser] = useState([]);\r\n  const [text, setText] = useState(\"\");\r\n  const [media, setMedia] = useState([]);\r\n  const [loadMedia, setLoadMedia] = useState(false);\r\n\r\n  const refDisplay = useRef();\r\n  const pageEnd = useRef();\r\n\r\n  const [isDetail, setIsDetail] = useState(false);\r\n  const [isPhone, setIsPhone] = useState(false);\r\n  const [isAudio, setIsAudio] = useState(false);\r\n\r\n  const [data, setData] = useState([]);\r\n  const [result, setResult] = useState(9);\r\n  const [page, setPage] = useState(0);\r\n  const [isLoadMore, setIsLoadMore] = useState(0);\r\n\r\n  const history = useHistory();\r\n\r\n  useEffect(() => {\r\n    const newData = message.data.find((item) => item._id === id);\r\n    if (newData) {\r\n      setData(newData.messages);\r\n      setResult(newData.result);\r\n      setPage(newData.page);\r\n    }\r\n  }, [message.data, id]);\r\n\r\n  useEffect(() => {\r\n    if (id && message.users.length > 0) {\r\n      setIsDetail(false);\r\n      setTimeout(() => {\r\n        refDisplay.current.scrollIntoView({ behavior: \"smooth\", block: \"end\" });\r\n      }, 50);\r\n\r\n      const newUser = message.users.find((user) => user._id === id);\r\n      if (newUser) setUser(newUser);\r\n    }\r\n  }, [message.users, id]);\r\n\r\n  const handleChangeMedia = (e) => {\r\n    const files = [...e.target.files];\r\n    let err = \"\";\r\n    let newMedia = [];\r\n    files.forEach((file) => {\r\n      if (!file) return (err = \"File does not exist.\");\r\n\r\n      if (file.size > 1024 * 1024 * 5) {\r\n        return (err = \"This image/video larget is 5mb\");\r\n      }\r\n\r\n      return newMedia.push(file);\r\n    });\r\n\r\n    if (err)\r\n      dispatch({\r\n        type: NOTIFY_TYPES.NOTIFY,\r\n        payload: { error: err },\r\n      });\r\n    setMedia([...media, ...newMedia]);\r\n  };\r\n\r\n  const handleDeleteMedia = (index) => {\r\n    const newArr = [...media];\r\n    newArr.splice(index, 1);\r\n    setMedia(newArr);\r\n  };\r\n\r\n  const handleSubmit = async (e) => {\r\n    e.preventDefault();\r\n    if (!text.trim() && media.length === 0) return;\r\n    setText(\"\");\r\n    setMedia([]);\r\n    setLoadMedia(true);\r\n\r\n    let newArr = [];\r\n    if (media.length > 0) newArr = await imageUpload(media);\r\n    const msg = {\r\n      sender: auth.user._id,\r\n      recipient: id,\r\n      text,\r\n      media: newArr,\r\n      createdAt: new Date().toISOString(),\r\n    };\r\n    \r\n    setLoadMedia(false);\r\n    await dispatch(addMessageAction({ msg, auth, socket }));\r\n    if (refDisplay.current) {\r\n      refDisplay.current.scrollIntoView({\r\n        behavior: \"smooth\",\r\n        block: \"end\",\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleDeleteConversation = () => {\r\n    dispatch(deleteConversationAction({ auth, id }));\r\n    return history.push(\"/message\");\r\n  };\r\n\r\n  useEffect(() => {\r\n    const getMessagesData = async () => {\r\n      if (message.data.every((item) => item._id !== id)) {\r\n        await dispatch(getMessagesAction({ auth, id }));\r\n        setIsDetail(false);\r\n        setTimeout(() => {\r\n          refDisplay.current.scrollIntoView({\r\n            behavior: \"smooth\",\r\n            block: \"end\",\r\n          });\r\n        }, 50);\r\n      }\r\n    };\r\n    getMessagesData();\r\n  }, [id, auth, dispatch, message.data]);\r\n\r\n  //Load more\r\n\r\n  useEffect(() => {\r\n    const observer = new IntersectionObserver(\r\n      (entries) => {\r\n        if (entries[0].isIntersecting) {\r\n          setIsLoadMore((p) => p + 1);\r\n        }\r\n      },\r\n      {\r\n        threshold: 0.1,\r\n      }\r\n    );\r\n\r\n    observer.observe(pageEnd.current);\r\n  }, [setIsLoadMore]);\r\n\r\n  useEffect(() => {\r\n    if (isLoadMore > 1) {\r\n      if (result >= page * 9) {\r\n        dispatch(getMoreMessagesAction({ auth, id, page: page + 1 }));\r\n        setIsLoadMore(1);\r\n      }\r\n    }\r\n  }, [auth, dispatch, id, page, result, isLoadMore]);\r\n\r\n  //Call\r\n\r\n  const caller = ({ video }) => {\r\n    const { _id, avatar, username, fullname } = user;\r\n    const msg = {\r\n      sender: auth.user._id,\r\n      recipient: _id,\r\n      avatar,\r\n      username,\r\n      fullname,\r\n      video,\r\n    };\r\n    dispatch({\r\n      type: CALL_TYPES.CALL,\r\n      payload: msg,\r\n    });\r\n  };\r\n\r\n  const callUser = ({ video }) => {\r\n    const { _id, avatar, username, fullname } = auth.user;\r\n    const msg = {\r\n      sender: _id,\r\n      recipient: user._id,\r\n      avatar,\r\n      username,\r\n      fullname,\r\n      video,\r\n    };\r\n\r\n    if (peer.open) msg.peerId = peer._id;\r\n\r\n    socket.emit(\"callUser\", msg);\r\n  };\r\n\r\n  const handleAudioCall = () => {\r\n    caller({ video: false });\r\n    callUser({ video: false });\r\n  };\r\n\r\n  const handleVideoCall = () => {\r\n    caller({ video: true });\r\n    callUser({ video: true });\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div className=\"message-header\">\r\n        <div className=\"message-heading\">\r\n          {user.length !== 0 && (\r\n            <UserCard user={user} msg={true}>\r\n              <div className=\"message-heading-actions\">\r\n                <i\r\n                  className=\"fas fa-phone-alt message-heading-phone\"\r\n                  onClick={handleAudioCall}\r\n                ></i>\r\n                <i\r\n                  className=\"fas fa-video message-heading-video\"\r\n                  onClick={handleVideoCall}\r\n                ></i>\r\n                <i\r\n                  className=\"fas fa-info-circle\"\r\n                  style={{ color: isDetail ? \"\" : \"darkgray\" }}\r\n                  onClick={() => setIsDetail(!isDetail)}\r\n                ></i>\r\n              </div>\r\n            </UserCard>\r\n          )}\r\n        </div>\r\n\r\n        {isDetail ? (\r\n          <>\r\n            <div className=\"message-details\">\r\n              <div className=\"message-details-member\">\r\n                <h3 className=\"message-details-owner\">Members</h3>\r\n                {user.length !== 0 && <UserCard user={user} />}\r\n              </div>\r\n              <div className=\"message-details-actions\">\r\n                <button\r\n                  className=\"message-details-btn\"\r\n                  onClick={handleDeleteConversation}\r\n                >\r\n                  Delete Chat\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <div\r\n              className=\"message-chat\"\r\n              style={{\r\n                height:\r\n                  media.length > 0\r\n                    ? \"calc(100% - 186px)\"\r\n                    : \"calc(100% - 116px)\",\r\n              }}\r\n            >\r\n              <div className=\"message-chat-display\" ref={refDisplay}>\r\n                <button className=\"message-chat-btn\" ref={pageEnd}>\r\n                  LoadMore\r\n                </button>\r\n                {data.map((msg, index) => (\r\n                  <div key={index}>\r\n                    {msg.sender !== auth.user._id && (\r\n                      <div className=\"message-chat-row other-message\">\r\n                        <MsgDisplay user={user} msg={msg} />\r\n                      </div>\r\n                    )}\r\n\r\n                    {msg.sender === auth.user._id && (\r\n                      <div className=\"message-chat-row you-message\">\r\n                        <MsgDisplay user={auth.user} msg={msg} data={data} />\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                ))}\r\n\r\n                {loadMedia && (\r\n                  <div className=\"message-chat-row you-message\">\r\n                    <img src={LoadingIcon} alt=\"Loading\" />\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            <div\r\n              className=\"message-media\"\r\n              style={{ display: media.length > 0 ? \"grid\" : \"none\" }}\r\n            >\r\n              {media.map((item, index) => (\r\n                <div key={index} className=\"message-media-list\">\r\n                  {item.type.match(/video/i)\r\n                    ? videoShow(URL.createObjectURL(item))\r\n                    : imageShow(URL.createObjectURL(item))}\r\n                  <span\r\n                    className=\"message-media-close\"\r\n                    onClick={() => handleDeleteMedia(index)}\r\n                  >\r\n                    &times;\r\n                  </span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            <form className=\"message-form\" onSubmit={handleSubmit}>\r\n              <input\r\n                type=\"text\"\r\n                className=\"message-form-input\"\r\n                placeholder=\"Enter your message....\"\r\n                value={text}\r\n                onChange={(e) => setText(e.target.value)}\r\n              />\r\n\r\n              <div className=\"message-form-upload\">\r\n                <i className=\"fas fa-image message-form-icon\"></i>\r\n                <input\r\n                  type=\"file\"\r\n                  name=\"file\"\r\n                  className=\"message-form-file\"\r\n                  multiple\r\n                  accept=\"image/*,video/*\"\r\n                  onChange={handleChangeMedia}\r\n                />\r\n              </div>\r\n\r\n              <button\r\n                type=\"submit\"\r\n                className=\"message-form-btn\"\r\n                // disabled={text || media.length > 0 ? false : true}\r\n              >\r\n                Send\r\n              </button>\r\n            </form>\r\n          </>\r\n        )}\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default RightSide;\r\n"]},"metadata":{},"sourceType":"module"}