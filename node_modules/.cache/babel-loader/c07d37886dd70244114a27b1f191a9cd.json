{"ast":null,"code":"import _objectSpread from\"C:/Benkia/MERN/instagram-clone/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"C:/Benkia/MERN/instagram-clone/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useCallback,useEffect,useRef,useState}from\"react\";import{useDispatch,useSelector}from\"react-redux\";import{addMessageAction}from\"../../redux/actions/messageActions\";import{CALL_TYPES}from\"../../redux/types/callTypes\";import{NOTIFY_TYPES}from\"../../redux/types/notifyTypes\";import ProfileIcon from\"../ProfileIcon\";import\"./index.scss\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var CallModal=function CallModal(){var _useSelector=useSelector(function(state){return state;}),call=_useSelector.call,auth=_useSelector.auth,peer=_useSelector.peer,socket=_useSelector.socket;var dispatch=useDispatch();var _useState=useState(0),_useState2=_slicedToArray(_useState,2),hours=_useState2[0],setHours=_useState2[1];var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),mins=_useState4[0],setMins=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),second=_useState6[0],setSecond=_useState6[1];var _useState7=useState(0),_useState8=_slicedToArray(_useState7,2),total=_useState8[0],setTotal=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),answer=_useState10[0],setAnswer=_useState10[1];var youVideo=useRef();var otherVideo=useRef();var _useState11=useState(null),_useState12=_slicedToArray(_useState11,2),tracks=_useState12[0],setTracks=_useState12[1];//Set Time\nuseEffect(function(){var setTime=function setTime(){setTotal(function(t){return t+1;});setTimeout(setTime,1000);};setTime();return function(){return setTotal(0);};},[]);useEffect(function(){setSecond(total%60);setMins(parseInt(total/60));setHours(parseInt(total/3600));},[total]);var addCallMessage=useCallback(function(call,times,disconnect){if(call.recipient!==auth.user._id||disconnect){var msg={sender:call.sender,recipient:call.recipient,text:\"\",media:[],call:{video:call.video,times:times},createdAt:new Date().toISOString()};dispatch(addMessageAction({msg:msg,auth:auth,socket:socket}));}},[auth,dispatch,socket]);var handleEndCall=function handleEndCall(){if(tracks){tracks.forEach(function(track){return track.stop();});}var times=answer?total:0;socket.emit(\"endCall\",_objectSpread(_objectSpread({},call),{},{times:times}));addCallMessage(call,times);dispatch({type:CALL_TYPES.CALL,payload:null});};useEffect(function(){if(answer){setTotal(0);}else{var timer=setTimeout(function(){socket.emit(\"endCall\",_objectSpread(_objectSpread({},call),{},{times:0}));addCallMessage(call,0);dispatch({type:CALL_TYPES.CALL,payload:null});},15000);return function(){return clearTimeout(timer);};}},[dispatch,answer,call,socket,addCallMessage]);useEffect(function(){socket.on(\"endCallToClient\",function(data){if(tracks){tracks.forEach(function(track){return track.stop();});}addCallMessage(data,data.times);dispatch({type:CALL_TYPES.CALL,payload:null});});return function(){return socket.off(\"endCallToClient\");};},[socket,dispatch,tracks,addCallMessage,call]);//Stream media\nvar openStream=function openStream(video){var config={audio:true,video:video};return navigator.mediaDevices.getUserMedia(config);};var playStream=function playStream(tag,stream){var video=tag;video.srcObject=stream;video.play();};var handleAnswer=function handleAnswer(){openStream(call.video).then(function(stream){playStream(youVideo.current,stream);var track=stream.getTracks();setTracks(track);var newCall=peer.call(call.peerId,stream);newCall.on(\"stream\",function(remoteStream){playStream(otherVideo.current,remoteStream);});setAnswer(true);});};useEffect(function(){peer.on(\"call\",function(newCall){openStream(call.video).then(function(stream){if(youVideo.current){playStream(youVideo.current,stream);}var track=stream.getTracks();setTracks(track);newCall.answer(stream);newCall.on(\"stream\",function(remoteStream){if(otherVideo.current){playStream(otherVideo.current,remoteStream);}});setAnswer(true);});});return function(){return peer.removeListener(\"call\");};},[call.video,peer]);//disconnect\nuseEffect(function(){socket.on(\"callerDisconnect\",function(){tracks&&tracks.forEach(function(track){return track.stop();});console.log(\"user disconnect\");var times=answer?total:0;addCallMessage(call,times,true);dispatch({type:CALL_TYPES.CALL,payload:null});dispatch({type:NOTIFY_TYPES.NOTIFY,payload:{error:\"\".concat(call.username,\" disconnect\")}});});return function(){return socket.off(\"callerDisconnect\");};},[socket,tracks,dispatch,addCallMessage,total,call,answer]);return/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsxs(\"div\",{className:\"call-modal\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"call-box\",style:{display:answer&&call.video?\"none\":\"flex\"},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-content\",children:[/*#__PURE__*/_jsx(ProfileIcon,{src:call.avatar,size:\"supper-avatar\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-users\",children:[/*#__PURE__*/_jsx(\"h4\",{children:call.username}),/*#__PURE__*/_jsx(\"h6\",{children:call.fullname})]}),answer?/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-time\",children:[/*#__PURE__*/_jsx(\"span\",{children:hours.toString().length<2?\"0\"+hours:hours}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:mins.toString().length<2?\"0\"+mins:mins}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:second.toString().length<2?\"0\"+second:second})]}):/*#__PURE__*/_jsx(\"div\",{className:\"call-box-desc\",children:call.video?/*#__PURE__*/_jsx(\"span\",{children:\"calling video...\"}):/*#__PURE__*/_jsx(\"span\",{children:\"calling audio....\"})})]}),!answer&&/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-timer\",children:[/*#__PURE__*/_jsx(\"small\",{children:mins.toString().length<2?\"0\"+mins:mins}),/*#__PURE__*/_jsx(\"small\",{children:\":\"}),/*#__PURE__*/_jsx(\"small\",{children:second.toString().length<2?\"0\"+second:second})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-actions\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"material-icons call-box-cancel\",onClick:handleEndCall,children:\"call_end\"}),call.recipient===auth.user._id&&!answer&&/*#__PURE__*/_jsx(_Fragment,{children:call.video?/*#__PURE__*/_jsx(\"span\",{className:\"material-icons call-box-video\",onClick:handleAnswer,children:\"videocam\"}):/*#__PURE__*/_jsx(\"span\",{className:\"material-icons call-box-phone\",onClick:handleAnswer,children:\"call\"})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-showVideo\",style:{opacity:answer&&call.video?\"1\":\"0\"},children:[/*#__PURE__*/_jsx(\"video\",{src:\"#\",className:\"call-box-youVideo\",ref:youVideo}),/*#__PURE__*/_jsx(\"video\",{src:\"\",className:\"call-box-otherVideo\",ref:otherVideo}),/*#__PURE__*/_jsxs(\"div\",{className:\"call-box-timeVideo\",children:[/*#__PURE__*/_jsx(\"span\",{children:hours.toString().length<2?\"0\"+hours:hours}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:mins.toString().length<2?\"0\"+mins:mins}),/*#__PURE__*/_jsx(\"span\",{children:\":\"}),/*#__PURE__*/_jsx(\"span\",{children:second.toString().length<2?\"0\"+second:second})]}),/*#__PURE__*/_jsx(\"span\",{className:\"material-icons call-box-cancel call-box-endCall\",onClick:handleEndCall,children:\"call_end\"})]})]})});};export default CallModal;","map":{"version":3,"sources":["C:/Benkia/MERN/instagram-clone/client/src/components/CallModal/index.js"],"names":["React","useCallback","useEffect","useRef","useState","useDispatch","useSelector","addMessageAction","CALL_TYPES","NOTIFY_TYPES","ProfileIcon","CallModal","state","call","auth","peer","socket","dispatch","hours","setHours","mins","setMins","second","setSecond","total","setTotal","answer","setAnswer","youVideo","otherVideo","tracks","setTracks","setTime","t","setTimeout","parseInt","addCallMessage","times","disconnect","recipient","user","_id","msg","sender","text","media","video","createdAt","Date","toISOString","handleEndCall","forEach","track","stop","emit","type","CALL","payload","timer","clearTimeout","on","data","off","openStream","config","audio","navigator","mediaDevices","getUserMedia","playStream","tag","stream","srcObject","play","handleAnswer","then","current","getTracks","newCall","peerId","remoteStream","removeListener","console","log","NOTIFY","error","username","display","avatar","fullname","toString","length","opacity"],"mappings":"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","sourcesContent":["import React, { useCallback, useEffect, useRef, useState } from \"react\";\r\nimport { useDispatch, useSelector } from \"react-redux\";\r\nimport { addMessageAction } from \"../../redux/actions/messageActions\";\r\nimport { CALL_TYPES } from \"../../redux/types/callTypes\";\r\nimport { NOTIFY_TYPES } from \"../../redux/types/notifyTypes\";\r\nimport ProfileIcon from \"../ProfileIcon\";\r\nimport \"./index.scss\";\r\nconst CallModal = () => {\r\n  const { call, auth, peer, socket } = useSelector((state) => state);\r\n  const dispatch = useDispatch();\r\n\r\n  const [hours, setHours] = useState(0);\r\n  const [mins, setMins] = useState(0);\r\n  const [second, setSecond] = useState(0);\r\n  const [total, setTotal] = useState(0);\r\n\r\n  const [answer, setAnswer] = useState(false);\r\n  const youVideo = useRef();\r\n  const otherVideo = useRef();\r\n  const [tracks, setTracks] = useState(null);\r\n\r\n  //Set Time\r\n\r\n  useEffect(() => {\r\n    const setTime = () => {\r\n      setTotal((t) => t + 1);\r\n      setTimeout(setTime, 1000);\r\n    };\r\n    setTime();\r\n    return () => setTotal(0);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setSecond(total % 60);\r\n    setMins(parseInt(total / 60));\r\n    setHours(parseInt(total / 3600));\r\n  }, [total]);\r\n\r\n  const addCallMessage = useCallback(\r\n    (call, times, disconnect) => {\r\n      if (call.recipient !== auth.user._id || disconnect) {\r\n        const msg = {\r\n          sender: call.sender,\r\n          recipient: call.recipient,\r\n          text: \"\",\r\n          media: [],\r\n          call: {\r\n            video: call.video,\r\n            times,\r\n          },\r\n          createdAt: new Date().toISOString(),\r\n        };\r\n        dispatch(addMessageAction({ msg, auth, socket }));\r\n      }\r\n    },\r\n    [auth, dispatch, socket]\r\n  );\r\n\r\n  const handleEndCall = () => {\r\n    if (tracks) {\r\n      tracks.forEach((track) => track.stop());\r\n    }\r\n    let times = answer ? total : 0;\r\n    socket.emit(\"endCall\", { ...call, times });\r\n\r\n    addCallMessage(call, times);\r\n\r\n    dispatch({\r\n      type: CALL_TYPES.CALL,\r\n      payload: null,\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (answer) {\r\n      setTotal(0);\r\n    } else {\r\n      const timer = setTimeout(() => {\r\n        socket.emit(\"endCall\", { ...call, times: 0 });\r\n        addCallMessage(call, 0);\r\n\r\n        dispatch({\r\n          type: CALL_TYPES.CALL,\r\n          payload: null,\r\n        });\r\n      }, 15000);\r\n\r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [dispatch, answer, call, socket, addCallMessage]);\r\n\r\n  useEffect(() => {\r\n    socket.on(\"endCallToClient\", (data) => {\r\n      if (tracks) {\r\n        tracks.forEach((track) => track.stop());\r\n      }\r\n      addCallMessage(data, data.times);\r\n      dispatch({\r\n        type: CALL_TYPES.CALL,\r\n        payload: null,\r\n      });\r\n    });\r\n\r\n    return () => socket.off(\"endCallToClient\");\r\n  }, [socket, dispatch, tracks, addCallMessage, call]);\r\n\r\n  //Stream media\r\n  const openStream = (video) => {\r\n    const config = { audio: true, video };\r\n    return navigator.mediaDevices.getUserMedia(config);\r\n  };\r\n\r\n  const playStream = (tag, stream) => {\r\n    let video = tag;\r\n    video.srcObject = stream;\r\n    video.play();\r\n  };\r\n\r\n  const handleAnswer = () => {\r\n    openStream(call.video).then((stream) => {\r\n      playStream(youVideo.current, stream);\r\n      const track = stream.getTracks();\r\n      setTracks(track);\r\n\r\n      const newCall = peer.call(call.peerId, stream);\r\n      newCall.on(\"stream\", function (remoteStream) {\r\n        playStream(otherVideo.current, remoteStream);\r\n      });\r\n\r\n      setAnswer(true);\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    peer.on(\"call\", (newCall) => {\r\n      openStream(call.video).then((stream) => {\r\n        if (youVideo.current) {\r\n          playStream(youVideo.current, stream);\r\n        }\r\n\r\n        const track = stream.getTracks();\r\n        setTracks(track);\r\n\r\n        newCall.answer(stream);\r\n\r\n        newCall.on(\"stream\", function (remoteStream) {\r\n          if (otherVideo.current) {\r\n            playStream(otherVideo.current, remoteStream);\r\n          }\r\n        });\r\n\r\n        setAnswer(true);\r\n      });\r\n    });\r\n\r\n    return () => peer.removeListener(\"call\");\r\n  }, [call.video, peer]);\r\n\r\n  //disconnect\r\n  useEffect(() => {\r\n    socket.on(\"callerDisconnect\", () => {\r\n      tracks && tracks.forEach((track) => track.stop());\r\n\r\n      console.log(\"user disconnect\");\r\n\r\n      let times = answer ? total : 0;\r\n      addCallMessage(call, times, true);\r\n\r\n      dispatch({\r\n        type: CALL_TYPES.CALL,\r\n        payload: null,\r\n      });\r\n\r\n      dispatch({\r\n        type: NOTIFY_TYPES.NOTIFY,\r\n        payload: { error: `${call.username} disconnect` },\r\n      });\r\n    });\r\n\r\n    return () => socket.off(\"callerDisconnect\");\r\n  }, [socket, tracks, dispatch, addCallMessage, total, call, answer]);\r\n\r\n  return (\r\n    <>\r\n      <div className=\"call-modal\">\r\n        <div\r\n          className=\"call-box\"\r\n          style={{ display: answer && call.video ? \"none\" : \"flex\" }}\r\n        >\r\n          <div className=\"call-box-content\">\r\n            <ProfileIcon src={call.avatar} size=\"supper-avatar\" />\r\n            <div className=\"call-box-users\">\r\n              <h4>{call.username}</h4>\r\n              <h6>{call.fullname}</h6>\r\n            </div>\r\n\r\n            {answer ? (\r\n              <div className=\"call-box-time\">\r\n                <span>{hours.toString().length < 2 ? \"0\" + hours : hours}</span>\r\n                <span>:</span>\r\n                <span>{mins.toString().length < 2 ? \"0\" + mins : mins}</span>\r\n                <span>:</span>\r\n                <span>\r\n                  {second.toString().length < 2 ? \"0\" + second : second}\r\n                </span>\r\n              </div>\r\n            ) : (\r\n              <div className=\"call-box-desc\">\r\n                {call.video ? (\r\n                  <span>calling video...</span>\r\n                ) : (\r\n                  <span>calling audio....</span>\r\n                )}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {!answer && (\r\n            <div className=\"call-box-timer\">\r\n              <small>{mins.toString().length < 2 ? \"0\" + mins : mins}</small>\r\n              <small>:</small>\r\n              <small>\r\n                {second.toString().length < 2 ? \"0\" + second : second}\r\n              </small>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"call-box-actions\">\r\n            <span\r\n              className=\"material-icons call-box-cancel\"\r\n              onClick={handleEndCall}\r\n            >\r\n              call_end\r\n            </span>\r\n\r\n            {call.recipient === auth.user._id && !answer && (\r\n              <>\r\n                {call.video ? (\r\n                  <span\r\n                    className=\"material-icons call-box-video\"\r\n                    onClick={handleAnswer}\r\n                  >\r\n                    videocam\r\n                  </span>\r\n                ) : (\r\n                  <span\r\n                    className=\"material-icons call-box-phone\"\r\n                    onClick={handleAnswer}\r\n                  >\r\n                    call\r\n                  </span>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div\r\n          className=\"call-box-showVideo\"\r\n          style={{ opacity: answer && call.video ? \"1\" : \"0\" }}\r\n        >\r\n          <video src=\"#\" className=\"call-box-youVideo\" ref={youVideo}></video>\r\n          <video\r\n            src=\"\"\r\n            className=\"call-box-otherVideo\"\r\n            ref={otherVideo}\r\n          ></video>\r\n\r\n          <div className=\"call-box-timeVideo\">\r\n            <span>{hours.toString().length < 2 ? \"0\" + hours : hours}</span>\r\n            <span>:</span>\r\n            <span>{mins.toString().length < 2 ? \"0\" + mins : mins}</span>\r\n            <span>:</span>\r\n            <span>{second.toString().length < 2 ? \"0\" + second : second}</span>\r\n          </div>\r\n\r\n          <span\r\n            className=\"material-icons call-box-cancel call-box-endCall\"\r\n            onClick={handleEndCall}\r\n          >\r\n            call_end\r\n          </span>\r\n        </div>\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default CallModal;\r\n"]},"metadata":{},"sourceType":"module"}